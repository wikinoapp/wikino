# ファイル添付機能 実装タスク

## 1. インフラ・基盤設定

### 1.1 Active Storage設定

- [x] Active Storageのインストールと設定
  - `rails active_storage:install`を実行
  - マイグレーションファイルの確認と実行
- [x] ストレージサービスの設定
  - 開発環境・本番環境: Cloudflare R2の設定を`config/storage.yml`に追加
- [x] 環境別のストレージ設定
  - `config/environments/development.rb`でCloudflare R2を使用
  - `config/environments/production.rb`でCloudflare R2を使用

### 1.2 データベース設計

- [x] attachmentsテーブルの作成
  - id (ULID)
  - space_id (外部キー)
  - active_storage_attachment_id (外部キー)
  - attached_user_id (外部キー)
  - attached_at (timestamp)
- [x] page_attachment_referencesテーブルの作成
  - id (ULID)
  - attachment_id (外部キー)
  - page_id (外部キー)

## 2. バックエンド実装

### 2.1 モデル・レコード

- [x] AttachmentRecordの実装
  - ActiveStorageとの関連付け
  - スコープ: by_space, by_user, recent
- [x] PageAttachmentReferenceRecordの実装
  - ページとの関連付け
  - 表示順序の管理

### 2.2 ファイルアップロードAPI

- [ ] ダイレクトアップロード用エンドポイントの実装
  - `POST /s/:space_identifier/attachments/presign`
  - ファイルサイズ・形式の事前検証
  - 署名付きURLの生成
- [ ] アップロード完了通知エンドポイント
  - `POST /s/:space_identifier/attachments`
  - Attachmentレコードの作成
  - ファイル検証処理の実行

### 2.3 ファイル検証・処理

- [ ] ファイル形式検証サービスの実装
  - MIMEタイプのホワイトリスト管理
  - マジックナンバーによる検証
  - SVGファイルのサニタイズ処理
- [ ] 画像処理サービスの実装
  - EXIF情報の削除（プライバシー保護）
  - 自動回転補正
  - ファイル名のサニタイズ

### 2.4 アクセス制御

- [ ] ファイルアクセスポリシーの実装
  - スペースメンバーシップの確認
  - 権限に応じたアクセス制御
- [ ] 署名付きURL生成サービス
  - 1時間の有効期限設定
  - アクセス権限の検証

### 2.5 ファイル管理API

- [ ] ファイル一覧エンドポイント
  - `GET /s/:space_identifier/settings/attachments`
  - 権限に応じたフィルタリング
  - 検索・ページネーション機能
- [ ] ファイル削除エンドポイント
  - `DELETE /s/:space_identifier/settings/attachments/:attachment_id`
  - 権限チェック
  - 関連するページ内リンクの処理

## 3. フロントエンド実装

### 3.1 エディタ統合

- [ ] ドラッグ&ドロップ機能の実装
  - CodeMirror 6へのドロップゾーン追加
  - ドラッグ中のビジュアルフィードバック
- [ ] ペースト機能の実装
  - クリップボードAPIの使用
  - 画像ペースト時の自動アップロード
- [ ] アップロード進捗表示
  - 「アップロード中...」テキストの挿入
  - 完了後のURL置換処理

### 3.2 ファイルアップローダー

- [ ] DirectUploadクラスの実装
  - ファイルサイズ・形式の事前検証
  - 進捗イベントの処理
  - エラーハンドリング
- [ ] リトライ機能の実装
  - 最大3回のリトライ
  - エクスポネンシャルバックオフ

### 3.3 Markdownレンダリング

- [ ] 画像の署名付きURL変換
  - Markdown→HTML変換時の処理
  - アクセス権限に応じたURL生成
- [ ] 画像のインライン表示
  - 対応フォーマットの判定
  - クリックで新規タブ表示

### 3.4 ファイル管理画面

- [ ] ファイル一覧コンポーネント
  - サムネイル表示（画像）
  - ファイルアイコン表示（その他）
  - メタデータ表示
- [ ] 検索・フィルタリング機能
  - ファイル名検索
  - 拡張子フィルター
- [ ] ページネーション実装
  - 50件ずつの表示
- [ ] ファイル削除機能
  - 削除確認ダイアログ
  - 削除後の通知

## 4. セキュリティ実装

### 4.1 アップロードセキュリティ

- [ ] CSRFトークン検証
- [ ] ファイルサイズ制限の実装
  - クライアント側検証
  - サーバー側検証
- [ ] 実行可能ファイルのブロック

### 4.2 アクセスセキュリティ

- [ ] 署名付きURLの実装

## 5. テスト

### 5.1 バックエンドテスト

- [ ] モデルのユニットテスト
- [ ] APIエンドポイントのリクエストスペック
- [ ] ファイル検証サービスのテスト
- [ ] アクセス制御のテスト

### 5.2 フロントエンドテスト

- [ ] アップロード機能のE2Eテスト
- [ ] ドラッグ&ドロップのテスト
- [ ] エラーハンドリングのテスト

### 5.3 セキュリティテスト

- [ ] ファイルアップロードの脆弱性テスト
- [ ] アクセス制御のテスト
- [ ] XSS対策のテスト（SVGファイル）
