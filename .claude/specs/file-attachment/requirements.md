# ファイル添付機能の要件

## 機能要件

### ファイル添付

#### 基本機能
- ページにファイルが添付できる
- ファイルをクリップボードに保存し、Markdownエディタにフォーカスが当てた状態でペーストしたとき、ファイル添付できる
- ドラッグ&ドロップでファイルを添付できる
- 複数ファイルの同時アップロードに対応

#### アクセス制御
- ページ本文のMarkdownテキストにはアクセス可能か確認できるURLを埋め込む
- ページ本文のMarkdownテキストをHTMLに変換するとき、アクセス可能か確認できるURLを署名付きURLに置き換える
  - 署名付きURLには有効期限を設定（デフォルト: 1時間）

#### アップロード方式
- ダイレクトアップロードを採用
  - [Rails公式ガイド - ダイレクトアップロード](https://railsguides.jp/active_storage_overview.html#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89)
  - ブラウザから直接S3にアップロードし、サーバー負荷を軽減

#### 制限事項
- 添付ファイルのサイズ制限
  - 画像: 1ファイル10MBまで
  - 動画: 1ファイル100MBまで
  - その他: 1ファイル25MBまで
  - クライアント側とサーバー側の両方で検証
- スペース内にアップロードできるファイルのサイズ制限
  - 現時点では設けない（将来的に有料プランで差別化する可能性あり）
- アップロード可能なファイル形式
  - 画像
    - JPEG (.jpg, .jpeg)
    - PNG (.png)
    - GIF (.gif)
    - SVG (.svg)
      - セキュリティ対策として、アップロード時にスクリプトタグを除去
      - XMLパーサーでの検証を実施
  - 動画
    - MP4 (.mp4)
    - WebM (.webm)
    - MOV (.mov)
  - その他
    - PDF (.pdf)
    - Microsoft Officeファイル (.docx, .pptx, .xlsx, .xls)
    - テキストファイル (.txt, .csv, .log, .md, .json, .jsonc)
    - 圧縮ファイル (.zip, .gz, .tgz)

### 画像展開

#### 表示機能
- 添付したファイルが画像のときインライン表示されるようにする
- 画像をクリックしたとき、新しいタブで画像を開く
- EXIF情報に基づく自動回転補正

### 添付ファイル管理

#### ファイル一覧画面
- `GET /s/:space_identifier/settings/attachments`
  - スペース内でアップロードされた添付ファイルが一覧できる
  - メンバー権限によって表示される添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが参照できる
      - ファイルごとのストレージ使用量を表示
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが参照できる
  - 添付ファイル名で検索できる（キーワード検索）
    - 部分一致検索に対応
    - ファイル名の他、拡張子でもフィルタリング可能
  - 添付ファイル数が多いときページネーションでページ分割する（50件ずつ）
    - 無限スクロール対応も検討
  - ソート機能
    - アップロード日時（新しい順/古い順）
    - ファイル名（昇順/降順）
    - ファイルサイズ（大きい順/小さい順）

#### ファイル削除
- `DELETE /s/:space_identifier/settings/attachments/:attachment_id`
  - 添付ファイルが削除できる
  - メンバー権限によって削除できる添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが削除できる
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが削除できる
  - 削除確認ダイアログを表示
  - 削除後30日間は復元可能（論理削除）
  - 関連するページ内のリンクは自動的に無効化される

## セキュリティ要件

### アップロード時の検証
- ファイルアップロード時のウイルススキャン
  - ClamAVまたはクラウドベースのウイルススキャンサービスを使用
  - スキャン完了まではファイルへのアクセスを制限
- アップロード可能なファイル形式の制限（実行可能ファイルの除外など）
  - MIMEタイプのホワイトリスト管理
- Content-Typeの検証とファイル内容の検証
  - マジックナンバーによるファイル形式の検証
  - 拡張子とContent-Typeの整合性チェック
- ファイル名のサニタイズ（パストラバーサル対策）
  - 特殊文字の除去・置換
  - Unicode正規化（NFC）
  - 最大255バイトに制限

### アクセス制御
- 非公開ファイルのアクセス制御（署名付きURLの利用など）
  - AWS S3の署名付きURL機能を使用
  - URLの有効期限設定（デフォルト1時間、最大24時間）
- CSRF対策（ダイレクトアップロード時）
  - Railsの標準的なCSRFトークン検証を使用

## 技術的な実装方針

### インフラストラクチャ
- Active Storageの設定（S3などのストレージサービス選定）
  - 本番環境: AWS S3
  - 開発環境: ローカルストレージ
  - リージョン: 東京リージョン（ap-northeast-1）
- CDNの活用（パフォーマンス向上）
  - CloudFrontを使用し、世界中からの高速アクセスを実現
  - キャッシュ期間: 公開ファイルは1年、非公開ファイルはキャッシュなし

### 画像処理
- バリアント処理（画像のサムネイル生成など）
  - ImageMagickまたはlibvipsを使用
  - 遅延処理でオンデマンド生成
  - 生成済みバリアントはキャッシュ

### エラーハンドリング
- 非同期アップロードのエラーハンドリング
  - リトライ機能（最大3回）
  - 部分的アップロードの再開機能
  - エラー時の詳細なログ記録
- ファイル削除時の関連データ整合性（ページ内のリンク処理）
  - 削除前に関連ページを検索し、警告を表示
  - バックグラウンドジョブで関連リンクを無効化

### ブラウザ対応
- ブラウザ互換性（ドラッグ&ドロップ、ペースト処理）
  - Chrome、Firefox、Safari、Edge の最新版をサポート
  - File API、Drag and Drop API、Clipboard APIを使用
  - プログレッシブエンハンスメントで古いブラウザでも基本機能は動作

## UI/UX要件

### アップロード体験
- アップロード進捗表示
  - プログレスバーで進捗率を表示
  - アップロード速度と残り時間の推定表示
  - バックグラウンドアップロード対応（ページ遷移しても継続）
- ドラッグ&ドロップ対応
  - エディタ全体をドロップゾーンとして機能
  - ドラッグ中は視覚的フィードバック（ハイライト表示）
- 複数ファイル同時アップロード
  - 最大10ファイルまで同時アップロード可能
  - キューイング機能で順次処理

### フィードバック
- アップロードエラー時の明確なフィードバック
  - エラーの種類に応じた具体的なメッセージ
  - 解決方法の提案（ファイルサイズ超過時は圧縮を提案など）
- ファイル一覧でのプレビュー表示
  - 画像: サムネイル表示
  - その他: ファイルアイコンとメタデータ表示
- ファイルサイズ・形式の事前検証
  - 選択時点で制限チェック
  - 不適切なファイルは選択リストから自動除外

## データベース設計

### データ構造
- 添付ファイルとページの関連付け
  - 中間テーブル（page_attachments）で多対多の関係を管理
  - ページ内での表示順序を保持
- アップロードユーザーの記録
  - uploaded_by_user_id カラムで記録
  - IPアドレスとユーザーエージェントも記録（セキュリティ監査用）
- メタデータの保存
  - ファイルサイズ（バイト単位）
  - MIME-Type
  - アップロード日時
  - 最終アクセス日時
  - ダウンロード回数
  - ファイルハッシュ（SHA-256）

### パフォーマンス最適化
- 検索用インデックス
  - ファイル名（全文検索インデックス）
  - アップロード日時
  - ユーザーID
  - スペースIDとの複合インデックス
- 論理削除の検討
  - deleted_at カラムで論理削除を実装
  - 30日後にバックグラウンドジョブで物理削除
  - 削除済みファイルの復元機能を提供

### 統計情報
- スペースごとのストレージ使用量追跡
- ユーザーごとのアップロード統計
- 人気ファイルのランキング機能（将来実装）
