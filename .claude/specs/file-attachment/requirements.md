# ファイル添付機能の要件

## 機能要件

### ファイル添付

#### 基本機能
- ページにファイルが添付できる
- ファイルをクリップボードに保存し、Markdownエディタにフォーカスが当てた状態でペーストしたとき、ファイル添付できる
- ドラッグ&ドロップでファイルを添付できる

#### アクセス制御
- ページ本文のMarkdownテキストにはアクセス可能か確認できるURLを埋め込む
- ページ本文のMarkdownテキストをHTMLに変換するとき、アクセス可能か確認できるURLを署名付きURLに置き換える
  - 署名付きURLには有効期限を設定（1時間で失効）

#### アップロード方式
- ダイレクトアップロードを採用
  - [Rails公式ガイド - ダイレクトアップロード](https://railsguides.jp/active_storage_overview.html#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89)
  - ブラウザから直接S3にアップロードし、サーバー負荷を軽減

#### 制限事項
- 添付ファイルのサイズ制限
  - 画像: 1ファイル10MBまで
  - 動画: 1ファイル100MBまで
  - その他: 1ファイル25MBまで
  - クライアント側とサーバー側の両方で検証
- スペース内にアップロードできるファイルのサイズ制限
  - 現時点では設けない（将来的に有料プランで差別化する可能性あり）
- アップロード可能なファイル形式
  - 画像
    - JPEG (.jpg, .jpeg)
    - PNG (.png)
    - GIF (.gif)
    - SVG (.svg)
      - セキュリティ対策として、アップロード時にスクリプトタグを除去
      - XMLパーサーでの検証を実施
  - 動画
    - MP4 (.mp4)
    - WebM (.webm)
    - MOV (.mov)
  - その他
    - PDF (.pdf)
    - Microsoft Officeファイル (.docx, .pptx, .xlsx, .xls)
    - テキストファイル (.txt, .csv, .log, .md, .json, .jsonc)
    - 圧縮ファイル (.zip, .gz, .tgz)

### 画像展開

#### 表示機能
- 添付したファイルが画像のときインライン表示されるようにする
- 画像をクリックしたとき、新しいタブで画像を開く
- EXIF情報に基づく自動回転補正
- プライバシー保護のため、以下のEXIFデータを削除
  - 位置情報: GPSLatitude, GPSLongitude, GPSAltitude, GPSTimeStamp, GPSImgDirection
  - 個人情報: Artist, Copyright, CameraOwnerName, BodySerialNumber, LensSerialNumber
  - 詳細情報: SubSecTime, UserComment, ImageDescription, XPTitle, XPComment, XPAuthor
  - ソフトウェア情報: Software, ProcessingSoftware
  - ただし、Orientationタグは自動回転処理のため保持し、処理後に正規化

### 添付ファイル管理

#### ファイル一覧画面
- `GET /s/:space_identifier/settings/attachments`
  - スペース内でアップロードされた添付ファイルが一覧できる
  - メンバー権限によって表示される添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが参照できる
      - ファイルごとのストレージ使用量を表示
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが参照できる
  - 添付ファイル名で検索できる（キーワード検索）
    - 部分一致検索に対応
    - ファイル名の他、拡張子でもフィルタリング可能
  - 添付ファイル数が多いときページネーションでページ分割する（50件ずつ）
  - アップロード日時が新しい順に表示する

#### ファイル削除
- `DELETE /s/:space_identifier/settings/attachments/:attachment_id`
  - 添付ファイルが削除できる
  - メンバー権限によって削除できる添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが削除できる
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが削除できる
  - 削除確認ダイアログを表示

## セキュリティ要件

### アップロード時の検証
- アップロード可能なファイル形式の制限（実行可能ファイルの除外など）
  - MIMEタイプのホワイトリスト管理
- Content-Typeの検証とファイル内容の検証
  - マジックナンバーによるファイル形式の検証
  - 拡張子とContent-Typeの整合性チェック
- ファイル名のサニタイズ（パストラバーサル対策）
  - 特殊文字の除去・置換
  - Unicode正規化（NFC）
  - 最大255バイトに制限

### アクセス制御
- 非公開ファイルのアクセス制御（署名付きURLの利用など）
  - 署名付きURL機能を使用
  - URLの有効期限設定（1時間で失効）
- CSRF対策（ダイレクトアップロード時）
  - Railsの標準的なCSRFトークン検証を使用

## 技術的な実装方針

### インフラストラクチャ
- Active Storageの設定（S3などのストレージサービス選定）
  - 本番環境: Cloudflare R2
  - 開発環境: MinIO
- CDNの活用（パフォーマンス向上）
  - CloudFrontを使用し、世界中からの高速アクセスを実現
  - キャッシュ期間: 公開ファイルは1年、非公開ファイルはキャッシュなし

### エラーハンドリング
- 非同期アップロードのエラーハンドリング
  - リトライ機能（最大3回）
  - 部分的アップロードの再開機能
  - エラー時の詳細なログ記録
- ファイル削除時の関連データ整合性（ページ内のリンク処理）
  - 削除前に関連ページを検索し、警告を表示

### ブラウザ対応
- ブラウザ互換性（ドラッグ&ドロップ、ペースト処理）
  - Chrome、Firefox、Safari、Edge の最新版をサポート
  - File API、Drag and Drop API、Clipboard APIを使用

## UI/UX要件

### アップロード体験
- アップロード中の進捗表示
  - Markdownエディタに「アップロード中...」とテキストを表示する
    - アップロードが完了したらテキストをファイルのURLに置き換える
- ドラッグ&ドロップ対応
  - エディタ全体をドロップゾーンとして機能
  - ドラッグ中は視覚的フィードバック（ハイライト表示）

### フィードバック
- アップロードエラー時の明確なフィードバック
  - エラーの種類に応じた具体的なメッセージ
  - 解決方法の提案（ファイルサイズ超過時は圧縮を提案など）
- ファイル一覧でのプレビュー表示
  - 画像: サムネイル表示
  - その他: ファイルアイコンとメタデータ表示
- ファイルサイズ・形式の事前検証
  - 選択時点で制限チェック
  - 不適切なファイルは選択リストから自動除外

## データベース設計

### データ構造
- ActiveStorageのテーブルを定義
  - active_storage_blobs
  - active_storage_attachments
  - active_storage_variant_records
- 添付ファイルの情報を格納するテーブル (attachments) を定義
  - ActiveStorageのテーブルにカラムを追加しないようにするため
    - 将来的にActiveStorageのテーブルに変更があったときコンフリクトなどを起こさないようにするため
  - アップロードしたユーザー (attached_user_id)
  - アップロードした日時 (attached_at)
- 添付ファイルとページの関連付け
  - 中間テーブル（attachment_references）で多対多の関係を管理
