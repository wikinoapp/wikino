# ファイル添付機能の要件

## 機能

### ファイル添付

- ページにファイルが添付できる
- ファイルをクリップボードに保存し、Markdownエディタにフォーカスが当てた状態でペーストしたとき、ファイル添付できる
- 公開トピックのページにファイル添付したとき、そのファイルはインターネットから参照できるようにする
- 非公開トピックのページにファイル添付したとき、そのファイルはそのスペースのメンバーだけが参照できるようにする
- ダイレクトアップロードする
  - https://railsguides.jp/active_storage_overview.html#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89
- 添付ファイルのサイズ制限
  - 1ファイル500MBまで
- スペース内にアップロードできるファイルのサイズ制限
  - 設けない

### 画像展開

- 添付したファイルが画像のときインライン表示されるようにする
- 対応する画像フォーマット
  - jpg, png, gif, anime gif, heic (iPhoneで撮った写真)

### 添付ファイル管理

- `GET /s/:space_identifier/settings/attachments`
  - スペース内でアップロードされた添付ファイルが一覧できる
  - メンバー権限によって表示される添付ファイルが異なる
    - オーナー, 管理者
      - スペース内でアップロードされた添付ファイル全てが参照できる
    - 一般, ゲスト, リードオンリー
      - 自身がアップロードした添付ファイルだけが参照できる
  - 添付ファイル名で検索できる (キーワード検索)
  - 添付ファイル数が多いときページネーションでページ分割する (50件ずつ)
- `DELETE /s/:space_identifier/settings/attachments/:attachment_id`
  - 添付ファイルが削除できる
  - メンバー権限によって削除できる添付ファイルが異なる
    - オーナー, 管理者
      - スペース内でアップロードされた添付ファイル全てが削除できる
    - 一般, ゲスト, リードオンリー
      - 自身がアップロードした添付ファイルだけが削除できる

## セキュリティ

- ファイルアップロード時のウイルススキャン
- アップロード可能なファイル形式の制限（実行可能ファイルの除外など）
- Content-Typeの検証とファイル内容の検証
- ファイル名のサニタイズ（パストラバーサル対策）
- 非公開ファイルのアクセス制御（署名付きURLの利用など）
- CSRF対策（ダイレクトアップロード時）

## 技術的な実装方針

- Active Storageの設定（S3などのストレージサービス選定）
- バリアント処理（画像のサムネイル生成など）
- 非同期アップロードのエラーハンドリング
- ファイル削除時の関連データ整合性（ページ内のリンク処理）
- CDNの活用（パフォーマンス向上）
- ブラウザ互換性（ドラッグ&ドロップ、ペースト処理）

## UI/UX

- アップロード進捗表示
- ドラッグ&ドロップ対応
- 複数ファイル同時アップロード
- アップロードエラー時の明確なフィードバック
- ファイル一覧でのプレビュー表示
- ファイルサイズ・形式の事前検証

## データベース設計

- 添付ファイルとページの関連付け
- アップロードユーザーの記録
- メタデータの保存（ファイルサイズ、MIME-Type、アップロード日時）
- 検索用インデックス
- 論理削除の検討
