# ファイル添付機能

## 機能要件

### ファイル添付

#### 基本機能

- ページにファイルが添付できる
- ファイルをクリップボードに保存し、Markdownエディタにフォーカスが当てた状態でペーストしたとき、ファイル添付できる
- ドラッグ&ドロップでファイルを添付できる

#### アクセス制御

- ページ本文のMarkdownテキストにはアクセス可能か確認できるURLを埋め込む
- ページ本文のMarkdownテキストをHTMLに変換するとき、アクセス可能か確認できるURLを署名付きURLに置き換える
  - 署名付きURLには有効期限を設定（1時間で失効）

#### アップロード方式

- ダイレクトアップロードを採用
  - [Rails公式ガイド - ダイレクトアップロード](https://railsguides.jp/active_storage_overview.html#%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%E3%83%AD%E3%83%BC%E3%83%89)
  - ブラウザから直接S3にアップロードし、サーバー負荷を軽減

#### 制限事項

- 添付ファイルのサイズ制限
  - 画像: 1ファイル10MBまで
  - 動画: 1ファイル100MBまで
  - その他: 1ファイル25MBまで
  - クライアント側とサーバー側の両方で検証
- スペース内にアップロードできるファイルのサイズ制限
  - 現時点では設けない（将来的に有料プランで差別化する可能性あり）
- アップロード可能なファイル形式
  - 画像
    - JPEG (.jpg, .jpeg)
    - PNG (.png)
    - GIF (.gif)
    - SVG (.svg)
      - セキュリティ対策として、アップロード時にスクリプトタグを除去
      - XMLパーサーでの検証を実施
  - 動画
    - MP4 (.mp4)
    - WebM (.webm)
    - MOV (.mov)
  - その他
    - PDF (.pdf)
    - Microsoft Officeファイル (.docx, .pptx, .xlsx, .xls)
    - テキストファイル (.txt, .csv, .log, .md, .json, .jsonc)
    - 圧縮ファイル (.zip, .gz, .tgz)

### 画像展開

#### 表示機能

- 添付したファイルが画像のときインライン表示されるようにする
- 画像をクリックしたとき、新しいタブで画像を開く
- EXIF情報に基づく自動回転補正
- プライバシー保護のため、以下のEXIFデータを削除
  - 位置情報: GPSLatitude, GPSLongitude, GPSAltitude, GPSTimeStamp, GPSImgDirection
  - 個人情報: Artist, Copyright, CameraOwnerName, BodySerialNumber, LensSerialNumber
  - 詳細情報: SubSecTime, UserComment, ImageDescription, XPTitle, XPComment, XPAuthor
  - ソフトウェア情報: Software, ProcessingSoftware
  - ただし、Orientationタグは自動回転処理のため保持し、処理後に正規化

### 添付ファイル管理

#### ファイル一覧画面

- `GET /s/:space_identifier/settings/attachments`
  - スペース内でアップロードされた添付ファイルが一覧できる
  - メンバー権限によって表示される添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが参照できる
      - ファイルごとのストレージ使用量を表示
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが参照できる
  - 添付ファイル名で検索できる（キーワード検索）
    - 部分一致検索に対応
    - ファイル名の他、拡張子でもフィルタリング可能
  - 添付ファイル数が多いときページネーションでページ分割する（50件ずつ）
  - アップロード日時が新しい順に表示する

#### ファイル削除

- `DELETE /s/:space_identifier/settings/attachments/:attachment_id`
  - 添付ファイルが削除できる
  - メンバー権限によって削除できる添付ファイルが異なる
    - オーナー、管理者
      - スペース内でアップロードされた添付ファイル全てが削除できる
    - 一般、ゲスト、リードオンリー
      - 自身がアップロードした添付ファイルだけが削除できる
  - 削除確認ダイアログを表示

## セキュリティ要件

### アップロード時の検証

- アップロード可能なファイル形式の制限（実行可能ファイルの除外など）
  - MIMEタイプのホワイトリスト管理
- Content-Typeの検証とファイル内容の検証
  - マジックナンバーによるファイル形式の検証
  - 拡張子とContent-Typeの整合性チェック
- ファイル名のサニタイズ（パストラバーサル対策）
  - 特殊文字の除去・置換
  - Unicode正規化（NFC）
  - 最大255バイトに制限

### アクセス制御

- 非公開ファイルのアクセス制御（署名付きURLの利用など）
  - 署名付きURL機能を使用
  - URLの有効期限設定（1時間で失効）
- CSRF対策（ダイレクトアップロード時）
  - Railsの標準的なCSRFトークン検証を使用

## 技術的な実装方針

### インフラストラクチャ

- Active Storageの設定（S3などのストレージサービス選定）
  - 本番環境: Cloudflare R2
  - 開発環境: MinIO
- CDNの活用（パフォーマンス向上）
  - CloudFrontを使用し、世界中からの高速アクセスを実現
  - キャッシュ期間: 公開ファイルは1年、非公開ファイルはキャッシュなし

### エラーハンドリング

- 非同期アップロードのエラーハンドリング
  - リトライ機能（最大3回）
  - 部分的アップロードの再開機能
  - エラー時の詳細なログ記録
- ファイル削除時の関連データ整合性（ページ内のリンク処理）
  - 削除前に関連ページを検索し、警告を表示

### ブラウザ対応

- ブラウザ互換性（ドラッグ&ドロップ、ペースト処理）
  - Chrome、Firefox、Safari、Edge の最新版をサポート
  - File API、Drag and Drop API、Clipboard APIを使用

## UI/UX要件

### アップロード体験

- アップロード中の進捗表示
  - Markdownエディタに「アップロード中...」とテキストを表示する
    - アップロードが完了したらテキストをファイルのURLに置き換える
- ドラッグ&ドロップ対応
  - エディタ全体をドロップゾーンとして機能
  - ドラッグ中は視覚的フィードバック（ハイライト表示）

### フィードバック

- アップロードエラー時の明確なフィードバック
  - エラーの種類に応じた具体的なメッセージ
  - 解決方法の提案（ファイルサイズ超過時は圧縮を提案など）
- ファイル一覧でのプレビュー表示
  - 画像: サムネイル表示
  - その他: ファイルアイコンとメタデータ表示
- ファイルサイズ・形式の事前検証
  - 選択時点で制限チェック
  - 不適切なファイルは選択リストから自動除外

## データベース設計

### データ構造

- ActiveStorageのテーブルを定義
  - active_storage_blobs
  - active_storage_attachments
  - active_storage_variant_records
- 添付ファイルの情報を格納するテーブル (attachments) を定義
  - ActiveStorageのテーブルにカラムを追加しないようにするため
    - 将来的にActiveStorageのテーブルに変更があったときコンフリクトなどを起こさないようにするため
  - アップロードしたユーザー (attached_user_id)
  - アップロードした日時 (attached_at)
- 添付ファイルとページの関連付け
  - 中間テーブル（attachment_references）で多対多の関係を管理

## TODO

- [x] Markdownエディタ内の img 要素の width, height をHTMLにレンダリングしたときも保持するようにして画像の見た目上の大きさを変えられるようにする
- [x] コピペでファイルアップロードできるようにする
  - `.json`, `.gz`
- [x] 画像の署名付きURL変換（Markdown→HTML変換時の処理、アクセス権限に応じたURL生成、有効期限1時間）
- [x] 画像のインライン表示（JPEG/PNG/GIF/WebP/SVG対応、imgタグでのインライン表示、クリックで新規タブ表示）
- [x] Active Storageのインストールと設定（`rails active_storage:install`を実行、マイグレーションファイルの確認と実行）
- [x] ストレージサービスの設定（開発環境・本番環境: Cloudflare R2の設定を`config/storage.yml`に追加）
- [x] 環境別のストレージ設定（`config/environments/development.rb`でCloudflare R2を使用、`config/environments/production.rb`でCloudflare R2を使用）
- [x] attachmentsテーブルの作成（id (ULID)、space_id (外部キー)、active_storage_attachment_id (外部キー)、attached_space_member_id (外部キー)、attached_at (timestamp)）
- [x] page_attachment_referencesテーブルの作成（id (ULID)、attachment_id (外部キー)、page_id (外部キー)）
- [x] AttachmentRecordの実装（ActiveStorageとの関連付け、スコープ: by_space, by_space_member, recent）
- [x] PageAttachmentReferenceRecordの実装（ページとの関連付け、表示順序の管理）
- [x] ダイレクトアップロード用エンドポイントの実装（`POST /s/:space_identifier/attachments/presign`、ファイルサイズ・形式の事前検証、署名付きURLの生成）
- [x] アップロード完了通知エンドポイント（`POST /s/:space_identifier/attachments`、Attachmentレコードの作成、ファイル検証処理の実行）
- [x] ファイル形式検証サービスの実装（MIMEタイプのホワイトリスト管理、マジックナンバーによる検証、SVGファイルのサニタイズ処理）
- [x] 画像処理サービスの実装（EXIF情報の削除（プライバシー保護）、自動回転補正、ファイル名のサニタイズ）
- [x] ファイルアクセスポリシーの実装（スペースメンバーシップの確認、権限に応じたアクセス制御）
- [x] 署名付きURL生成サービス（1時間の有効期限設定、アクセス権限の検証）
- [x] ファイル一覧エンドポイント（`GET /s/:space_identifier/settings/attachments`、権限に応じたフィルタリング、検索・ページネーション機能）
- [x] ファイル削除エンドポイント（`DELETE /s/:space_identifier/settings/attachments/:attachment_id`、権限チェック、関連するページ内リンクの処理）
- [x] ドラッグ&ドロップ機能の実装（CodeMirror 6へのドロップゾーン追加、ドラッグ中のビジュアルフィードバック）
- [x] ペースト機能の実装（クリップボードAPIの使用、画像ペースト時の自動アップロード）
- [x] アップロード進捗表示（「アップロード中...」テキストの挿入、完了後のURL置換処理）
- [x] DirectUploadクラスの実装（ファイルサイズ・形式の事前検証、進捗イベントの処理、エラーハンドリング）
- [x] リトライ機能の実装（最大3回のリトライ、エクスポネンシャルバックオフ）
- [x] ファイル一覧コンポーネント
  - サムネイル表示（画像ファイル用）
  - ファイルアイコン表示（その他のファイル用）
  - メタデータ表示（ファイル名、サイズ、アップロード日時、アップロード者）
- [x] 検索・フィルタリング機能
  - ファイル名検索の実装
  - 拡張子フィルターの実装
  - リアルタイム検索の実装
- [x] ページネーション実装
  - 50件ずつの表示
  - ページ番号表示
  - 前後ページへのナビゲーション
- [x] ファイル削除機能
  - 削除確認ダイアログの実装
  - 削除処理の実装
  - 削除後の通知表示
  - 関連するページ内リンクの処理
- [x] CSRFトークン検証
  - アップロードリクエストでのCSRFトークン検証
  - 削除リクエストでのCSRFトークン検証
- [x] ファイルサイズ制限の実装
  - クライアント側検証（10MB制限）
  - サーバー側検証（10MB制限）
  - エラーメッセージの表示
- [x] 実行可能ファイルのブロック
  - 拡張子チェック（.exe, .bat, .sh等）
  - MIMEタイプチェック
  - マジックナンバーでの検証
- [x] 署名付きURLの実装
  - Cloudflare R2での署名付きURL生成
  - 有効期限の設定（1時間）
  - アクセス権限の検証
- [x] モデルのユニットテスト
  - AttachmentRecordのテスト
  - PageAttachmentReferenceRecordのテスト
  - バリデーションのテスト
- [x] APIエンドポイントのリクエストスペック
  - アップロードエンドポイントのテスト
  - 削除エンドポイントのテスト
  - 一覧取得エンドポイントのテスト
- [x] ファイル検証サービスのテスト
  - MIMEタイプ検証のテスト
  - ファイルサイズ検証のテスト
  - マジックナンバー検証のテスト
- [x] アクセス制御のテスト
  - スペースメンバーのみアクセス可能なことを確認
  - 権限に応じた操作制限のテスト
- [x] アップロード機能のE2Eテスト
  - ドラッグ&ドロップでのアップロード
  - ペーストでのアップロード
  - ファイル選択でのアップロード
- [x] ドラッグ&ドロップのテスト
  - ドロップゾーンの表示確認
  - ファイルドロップ時の処理確認
- [x] エラーハンドリングのテスト
  - ネットワークエラー時のリトライ
  - ファイルサイズ超過時のエラー表示
  - 無効なファイル形式時のエラー表示
- [x] ファイルアップロードの脆弱性テスト
  - パストラバーサル攻撃の防止確認
  - ファイル名インジェクションの防止確認
- [x] XSS対策のテスト（SVGファイル）
  - SVGファイル内のスクリプトタグ除去確認
  - イベントハンドラー属性の除去確認
- [x] エクスポート機能の修正
  - エクスポートファイルに添付ファイルを含めるようにする
  - 添付ファイルを`attachments`ディレクトリに格納
  - Markdown内の `/attachments/{id}` を相対パス `attachments/{filename}` に変換
  - 画像タグ: `<img src="/attachments/{id}">` → `<img src="attachments/{filename}">`
  - リンク: `[text](/attachments/{id})` → `[text](attachments/{filename})`
  - VSCodeなどで開いたときに正しく参照できるようにする
- [x] body_htmlキャッシュの実装（非同期URL更新方式）
  - [x] マイグレーション作成 - body_htmlカラムを3つのテーブルに追加
  - [x] AttachmentFilterの修正 - プレースホルダー生成
  - [x] バッチ署名URL取得エンドポイントの作成
  - [x] Stimulusコントローラー作成 - 非同期URL置換
  - [x] PageRepositoryの修正 - キャッシュ利用
  - [x] ページ保存時のbody_html生成処理追加
  - [x] テストの作成
- [x] 画像を `loading=lazy` で表示する
- [x] ページに表示された画像のスタイル調整
  - 画像を中央寄せしたい
- [x] Markdownエディタ上でのペースト処理の修正
- [x] 画像や動画のキャプションっぽいものが表示できるようにする
  - img要素の隣接のem要素に対してCSSを当ててキャプションっぽくする
- [x] 退会処理の見直し
