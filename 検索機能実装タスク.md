# 検索機能実装タスク

## 概要

参加しているスペース内のページを検索できる機能を実装します。

## 要件

- URL: `GET /search?q=キーワード`
- 検索対象: ユーザーが参加しているスペース内のページ
- 検索方法: ページタイトルの部分一致検索（ILIKE）
- UI: キーワード入力欄と検索結果のページリンク表示

## 実装状況

✅ **完了** - 2025年7月12日に実装完了

## 実装タスク

### ✅ 1. ルーティングの追加

`config/routes.rb` に検索ページのルートを追加
- **既存**: 既にルートが定義済み（`GET /search`）

### ✅ 2. コントローラーの作成

`app/controllers/search/show_controller.rb` を作成
- ユーザーが参加しているスペースからページを検索
- 検索パラメータ: `q`（keywordから変更）
- `PageRepository`を使用してRecordからModelに変換
- 検索結果を`T::Array[Page]`でビューに渡す

### ✅ 3. フォームオブジェクトの作成

`app/forms/pages/search_form.rb` を作成
- 属性名: `q`（keywordから変更）
- ビジネスエラーのチェック実装済み:
  - 検索キーワードの最小文字数チェック（2文字以上）
  - 検索キーワードの最大文字数チェック（100文字以下）
  - 検索キーワードの形式チェック（不正な文字`<>`の検出）
  - 空文字列やnilの場合の処理

### ✅ 4. ビューの作成

`app/views/search/show_view.rb` を作成
- 検索フォームの管理
- 検索結果の表示ロジック
- `T::Array[Page]`を受け取り、Pageモデルのメソッドを使用

### ✅ 5. ViewComponentテンプレートの作成

`app/views/search/show_view.html.erb` を作成
- ViewComponentを使用したテンプレート
- Tailwind CSSによるスタイリング
- 検索フォーム（GET方式、パラメータ名`q`）
- 検索結果のページリンク一覧
- エラーメッセージ表示機能

### ✅ 6. 翻訳ファイルの作成

- `config/locales/actions.ja.yml`: 検索ボタンの翻訳
- `config/locales/placeholders.ja.yml`: 検索フィールドのプレースホルダー
- `config/locales/messages.ja.yml`: 検索結果メッセージ
- `config/locales/meta.ja.yml`: ページタイトル
- `config/locales/nouns.ja.yml`: 検索キーワードラベル

### ✅ 7. テストの作成

- ✅ リクエストスペック: `spec/requests/search/show_spec.rb`
- ✅ フォームスペック: `spec/forms/pages/search_form_spec.rb`

## 実装の詳細

### データベースクエリ

```ruby
PageRecord
  .joins(space_record: :space_member_records)
  .where(space_member_records: { user_id: current_user_record!.id })
  .where("pages.title ILIKE ?", "%#{keyword}%")
  .order(modified_at: :desc)
  .limit(50)
```

- `PageRecord`を使用してページを検索
- `joins(space_record: :space_member_records)`でスペースメンバーシップを結合
- `user_id`で現在のユーザーのメンバーシップをフィルタ
- `ILIKE`でタイトルの部分一致検索（大文字小文字区別なし）
- 結果は50件に制限し、最近編集した順（modified_at降順）でソート

### データ変換

- `PageRepository#to_models`を使用してPageRecordからPageモデルに変換
- ビューには`T::Array[Page]`で渡す
- Pageモデルの`display_title`メソッドを使用（無題の場合の処理含む）

### UI/UX

- 検索フォームは`GET`メソッドを使用
- 検索パラメータ: `q`（一般的な検索パラメータ名）
- 検索結果は即座に表示（ページリロード）
- 検索結果がない場合は「検索結果が見つかりませんでした」と表示
- 検索結果は件数表示付きでカード形式で表示
- 各結果にはページタイトル、スペース/トピック名、最終更新日時を表示

### セキュリティ

- 必ずユーザーが参加しているスペースのページのみを検索
- SQLインジェクション対策（プレースホルダーの使用）
- XSS対策（ビューでの適切なエスケープ）
- 検索キーワードの形式チェック（`<>`などの不正文字を拒否）

### フォームバリデーション

- 最小文字数: 2文字以上
- 最大文字数: 100文字以下
- 禁止文字: `<`, `>`
- 空文字列・nilの場合は検索を実行しない
- **バリデーションメッセージのI18n対応完了**: エラーメッセージは`config/locales/forms.ja.yml`で管理

### 型安全性

- Sorbetによる型チェック対応
- 全メソッドに適切な型注釈を付与
- PageRecordからPageモデルへの変換で型安全性を確保

## 追加された機能

### 新しいPageNameの追加

- `PageName::Search`を追加してメタタグ設定に対応

### 多言語対応

- 日本語の翻訳ファイルを完全対応
- **フォームバリデーションエラーメッセージのI18n対応完了**:
  - `config/locales/forms.ja.yml`にバリデーションメッセージを定義
  - `Pages::SearchForm`でI18nキー（`:too_short`, `:too_long`, `:invalid`）を使用
  - テストスペックで日本語ロケールを設定して検証
