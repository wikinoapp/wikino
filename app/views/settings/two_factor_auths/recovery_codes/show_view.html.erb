<%= render Layouts::BasicComponent.new(current_page_name:, current_user:) do |layout| %>
  <%= layout.with_header do %>
    <%= render Headers::GlobalComponent.new(current_user:, current_page_name:) %>
  <% end %>

  <%= layout.with_main do %>
    <%= render Containers::MainComponent.new(
      content_screen: ContainerComponent::ContentScreen::Small
    ) do %>
      <%= render Headers::MainTitleComponent.new(title:) %>

      <%= render Basic::CardComponent.new(class_name: "bg-base-300 border border-brand-200") do |card| %>
        <%= card.with_body(class_name: "p-4") do %>
          <div class="prose max-w-none mb-6">
            <p><%= t("messages.two_factor_auth.recovery_codes_description") %></p>
          </div>

          <% codes_to_show = recovery_codes || user_two_factor_auth.recovery_codes %>
          <% if codes_to_show.any? %>
            <div class="mb-6 p-4 bg-base-100 rounded">
              <h3 class="font-semibold mb-2"><%= t("nouns.recovery_codes") %></h3>
              <div class="grid grid-cols-2 gap-2">
                <% codes_to_show.each do |code| %>
                  <code class="text-sm"><%= code %></code>
                <% end %>
              </div>
            </div>

            <% if show_download %>
              <div class="alert alert-info mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span><%= t("messages.two_factor_auth.save_recovery_codes") %></span>
              </div>
            <% end %>

            <div class="mb-6">
              <button class="btn btn-sm" onclick="window.print()">
                <%= t("verbs.print_recovery_codes") %>
              </button>
              <button class="btn btn-sm" onclick="downloadRecoveryCodes()">
                <%= t("verbs.download_recovery_codes") %>
              </button>
            </div>
            
            <script>
              function downloadRecoveryCodes() {
                const codes = <%= codes_to_show.to_json %>;
                const content = 'Wikino Recovery Codes\n' +
                               'Account: <%= current_user.email %>\n' +
                               'Generated: <%= l(Time.current, format: :long) %>\n\n' +
                               codes.join('\n') +
                               '\n\nKeep these codes in a safe place. Each code can only be used once.';
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wikino-recovery-codes.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
              }
            </script>
          <% else %>
            <p class="text-warning mb-6"><%= t("messages.two_factor_auth.no_recovery_codes") %></p>
          <% end %>

          <hr class="my-4">

          <h3 class="text-lg font-semibold mb-2"><%= t("nouns.regenerate_recovery_codes") %></h3>
          <p class="text-sm text-gray-600 mb-4"><%= t("messages.two_factor_auth.regenerate_warning") %></p>

          <%= form_with model: regeneration_form, url: settings_two_factor_auth_recovery_codes_list_path do |form| %>
            <div class="mb-4">
              <%= form.label :password, t("activemodel.attributes.user_session_form/creation.password"), class: "label" %>
              <%= form.password_field :password, class: "input input-bordered w-full", autocomplete: "current-password" %>
              <% if regeneration_form.errors[:password].any? %>
                <p class="text-error text-sm mt-1"><%= regeneration_form.errors[:password].first %></p>
              <% end %>
            </div>

            <div class="flex justify-between">
              <%= link_to t("verbs.back"), settings_two_factor_auth_path, class: "btn btn-ghost" %>
              <%= form.submit t("verbs.regenerate_recovery_codes"), class: "btn btn-warning", data: { turbo_confirm: t("messages.two_factor_auth.regenerate_confirmation") } %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%= layout.with_footer do %>
    <%= render Footers::GlobalComponent.new(signed_in: true) %>
  <% end %>
<% end %>