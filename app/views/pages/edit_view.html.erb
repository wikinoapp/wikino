<%= render Layouts::Column1Component.new(
  current_page_name:,
  current_user:,
  current_space: space,
  show_sidebar: false,
  show_bottom_navbar: false
) do |layout| %>
  <%= layout.with_main do %>
    <%= render BaseUI::ContainerComponent.new(
      as: BaseUI::ContainerComponent::As::Main,
      content_screen: BaseUI::ContainerComponent::ContentScreen::Full,
      options: {class: "flex flex-col gap-4 py-4 md:px-4"}
    ) do %>
      <% if draft_page.present? %>
        <div class="px-4 md:px-0">
          <div class="alert">
            <%= render BaseUI::IconComponent.new(name: "warning-circle-regular", size: "18px", class_name: "fill-amber-600") %>

            <h2>
              <%= t("messages.pages.current_page_is_draft") %>
            </h2>
          </div>
        </div>
      <% end %>

      <%= render BaseUI::CardComponent.new(class_name: "!rounded-none md:!rounded-xl") do |card| %>
        <%= card.with_body(class_name: "px-4") do %>
          <%= form_with(
            class: "form flex flex-col gap-6",
            data: { controller: "markdown-editor-form edit-suggestion-dialog" },
            model: form,
            method: :patch,
            url: page_path(space.identifier, page.number)
          ) do |f| %>
            <%= render BaseUI::FormErrorsComponent.new(errors: f.object.errors) %>

            <div class="flex flex-col gap-6 md:flex-row md:gap-4">
              <div class="flex flex-none flex-col gap-2">
                <%= render BaseUI::LabelComponent.new(form_builder: f, method: :topic_number) %>

                <%= f.select(
                  :topic_number,
                  options_from_collection_for_select(f.object.selectable_topics, :number, :name, f.object.topic_number),
                  {},
                  {
                    class: "bg-base-300 select select-bordered",
                    data: {action: "markdown-editor-form#saveAsDraft"}
                  }
                ) %>
              </div>

              <div class="flex flex-1 flex-col gap-2">
                <%= render BaseUI::LabelComponent.new(form_builder: f, method: :title) %>

                <%= f.text_field(:title, {
                  autofocus: f.object.autofocus_title?,
                  data: {action: "markdown-editor-form#saveAsDraft"}
                }) %>
              </div>
            </div>

            <div class="flex flex-col gap-2">
              <%= render BaseUI::LabelComponent.new(form_builder: f, method: :body) %>

              <div
                data-controller="markdown-editor"
                data-markdown-editor-space-identifier-value="<%= space.identifier %>"
                data-markdown-editor-body-value="<%= f.object.body %>"
                data-markdown-editor-autofocus-value="<%= f.object.autofocus_body? %>"
              >
                <div data-markdown-editor-target="codeMirror"></div>

                <%= f.text_area(:body, {
                  class: "hidden",
                  data: {
                    action: "markdown-editor-form#saveAsDraft",
                    markdown_editor_target: "textarea"
                  }
                }) %>
              </div>
            </div>

            <div class="flex items-center justify-between gap-2">
              <div class="flex gap-2">
                <%= f.button class: "btn rounded-full w-fit", type: :submit do %>
                  <%= render BaseUI::IconComponent.new(name: "floppy-disk", size: "18px", class_name: "fill-primary-foreground") %>

                  <%= t("verbs.save") %>
                <% end %>

                <% if can_create_edit_suggestion %>
                  <%= BaseUI::Modal::TriggerComponent.new(controller_name:, target_name:) do %>
                    <button
                      type="button"
                      class="btn-outline w-fit rounded-full"
                    >
                      <%= render BaseUI::IconComponent.new(name: "git-pull-request-regular", size: "18px") %>
                      編集提案する...
                    </button>
                  <% end %>
                <% end %>

                <%= link_to t("nouns.cancel"), page_path(space.identifier, page.number), {
                  class: "btn-ghost rounded-full w-fit"
                } %>

                <input
                  class="hidden"
                  data-markdown-editor-form-target="draftSaveButton"
                  formaction="<%= draft_page_path(space.identifier, page.number) %>"
                  type="submit"
                >
              </div>

              <div class="text-right">
                <turbo-frame id="markdown-editor-draft-saved-time"></turbo-frame>
              </div>
            </div>

            <% if can_create_edit_suggestion %>
              <%= render EditSuggestions::CreateModalComponent.new(
                form: EditSuggestions::CreateForm.new(
                  space_member_record: form.space_member_record,
                  topic_record: topic.instance_variable_get(:@topic_record),
                  page_record: page.instance_variable_get(:@page_record)
                ),
                space:,
                topic:,
                page:,
                existing_edit_suggestions:
              ) %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <div class="px-4 md:px-0">
        <turbo-frame id="markdown-editor-footer">
          <%= render Footers::PageComponent.new(page:, link_list:, backlink_list:) %>
        </turbo-frame>
      </div>
    <% end %>
  <% end %>
<% end %>
